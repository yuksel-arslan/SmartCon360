// ══════════════════════════════════════
// OBS — ORGANIZATIONAL BREAKDOWN STRUCTURE
// ══════════════════════════════════════

model ObsNode {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId    String   @map("project_id") @db.Uuid
  parentId     String?  @map("parent_id") @db.Uuid
  code         String   @db.VarChar(50)
  name         String   @db.VarChar(255)
  description  String?
  // Uniclass Ro tablosu: Ro_10 Client, Ro_20 Designer, Ro_30 Contractor...
  uniclassCode String?  @map("uniclass_code") @db.VarChar(30)
  // OmniClass 33: Project Roles
  omniclassCode String? @map("omniclass_code") @db.VarChar(30)
  level        Int      @default(1)
  sortOrder    Int      @default(0) @map("sort_order")
  path         String?  @db.VarChar(500)
  // Organizasyon tipi: company | department | team | individual
  nodeType     String   @default("company") @map("node_type") @db.VarChar(20)
  companyName  String?  @map("company_name") @db.VarChar(255)
  contactName  String?  @map("contact_name") @db.VarChar(100)
  contactEmail String?  @map("contact_email") @db.VarChar(255)
  contactPhone String?  @map("contact_phone") @db.VarChar(20)
  // WBS sorumluluğu — hangi WBS nodelarından sorumlu
  wbsResponsibility String[] @default([]) @map("wbs_responsibility") @db.Uuid
  isActive     Boolean  @default(true) @map("is_active")
  metadata     Json     @default("{}") 
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent   ObsNode?  @relation("ObsTree", fields: [parentId], references: [id], onDelete: Cascade)
  children ObsNode[] @relation("ObsTree")

  @@unique([projectId, code])
  @@index([projectId])
  @@index([parentId])
  @@index([path])
  @@map("obs_nodes")
}

// ══════════════════════════════════════
// BOQ — BILL OF QUANTITIES
// ══════════════════════════════════════

model BoqItem {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId    String   @map("project_id") @db.Uuid
  // CBS node bağlantısı — maliyet kodlaması
  cbsNodeId    String?  @map("cbs_node_id") @db.Uuid
  // WBS node bağlantısı — iş paketi
  wbsNodeId    String?  @map("wbs_node_id") @db.Uuid
  // LBS bağlantısı — lokasyon
  locationId   String?  @map("location_id") @db.Uuid
  // Uniclass Ss (Systems) veya Pr (Products) kodu
  uniclassCode  String?  @map("uniclass_code") @db.VarChar(30)
  // OmniClass 22: Work Results
  omniclassCode String?  @map("omniclass_code") @db.VarChar(30)
  itemCode     String   @map("item_code") @db.VarChar(50)
  description  String   @db.VarChar(1000)
  // Detay açıklama — özellikler, standartlar
  specification String?
  unit         String   @db.VarChar(20)
  quantity     Decimal  @db.Decimal(15, 4)
  unitRate     Decimal  @map("unit_rate") @db.Decimal(15, 4)
  totalAmount  Decimal  @map("total_amount") @db.Decimal(18, 2)
  currency     String   @default("USD") @db.VarChar(3)
  // Kullanıcının kendi BOQ dosyasından geliyorsa kaynak satır no
  sourceRowRef String?  @map("source_row_ref") @db.VarChar(50)
  // BOQ tipi: provisional | firm | prime_cost | daywork
  itemType     String   @default("firm") @map("item_type") @db.VarChar(20)
  // Onay durumu
  status       String   @default("draft") @db.VarChar(20)
  sortOrder    Int      @default(0) @map("sort_order")
  isActive     Boolean  @default(true) @map("is_active")
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cbsNode  CbsNode? @relation(fields: [cbsNodeId], references: [id])
  wbsNode  WbsNode? @relation(fields: [wbsNodeId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])

  @@index([projectId])
  @@index([cbsNodeId])
  @@index([wbsNodeId])
  @@index([locationId])
  @@index([itemCode])
  @@map("boq_items")
}

// ══════════════════════════════════════
// PROJECT DOCUMENTS
// ══════════════════════════════════════

model ProjectDocument {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId    String   @map("project_id") @db.Uuid
  // Doküman tipi: contract | master_program | cash_flow | specification
  //               method_statement | insurance | permit | correspondence | other
  documentType String   @map("document_type") @db.VarChar(30)
  title        String   @db.VarChar(500)
  description  String?
  // Sözleşme'ye özel alanlar
  contractValue   Decimal? @map("contract_value") @db.Decimal(18, 2)
  contractType    String?  @map("contract_type") @db.VarChar(50)
  // FIDIC, NEC3, NEC4, JCT, bespoke...
  contractForm    String?  @map("contract_form") @db.VarChar(50)
  // Program'a özel alanlar
  programBaseline DateTime? @map("program_baseline") @db.Date
  // Versiyon takibi
  version      String   @default("1.0") @db.VarChar(20)
  revision     String?  @db.VarChar(10)
  revisionDate DateTime? @map("revision_date") @db.Date
  // Dosya bilgileri
  fileName     String   @map("file_name") @db.VarChar(500)
  originalName String   @map("original_name") @db.VarChar(500)
  fileType     String   @map("file_type") @db.VarChar(20)
  fileSize     Int      @map("file_size")
  filePath     String   @map("file_path") @db.VarChar(1000)
  // Durum: draft | active | superseded | archived
  status       String   @default("active") @db.VarChar(20)
  uploadedBy   String?  @map("uploaded_by") @db.Uuid
  approvedBy   String?  @map("approved_by") @db.Uuid
  approvedAt   DateTime? @map("approved_at")
  isConfidential Boolean @default(false) @map("is_confidential")
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([documentType])
  @@index([status])
  @@map("project_documents")
}

// ══════════════════════════════════════
// CASH FLOW
// ══════════════════════════════════════

model CashFlowPeriod {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId       String   @map("project_id") @db.Uuid
  // Dönem tipi: monthly | quarterly | weekly
  periodType      String   @default("monthly") @map("period_type") @db.VarChar(20)
  periodNumber    Int      @map("period_number")
  periodStart     DateTime @map("period_start") @db.Date
  periodEnd       DateTime @map("period_end") @db.Date
  // Planlanan değerler
  plannedIncome   Decimal  @default(0) @map("planned_income") @db.Decimal(18, 2)
  plannedExpense  Decimal  @default(0) @map("planned_expense") @db.Decimal(18, 2)
  plannedCumIncome  Decimal @default(0) @map("planned_cum_income") @db.Decimal(18, 2)
  plannedCumExpense Decimal @default(0) @map("planned_cum_expense") @db.Decimal(18, 2)
  // Gerçekleşen değerler (ilerledikçe dolacak)
  actualIncome    Decimal  @default(0) @map("actual_income") @db.Decimal(18, 2)
  actualExpense   Decimal  @default(0) @map("actual_expense") @db.Decimal(18, 2)
  actualCumIncome   Decimal @default(0) @map("actual_cum_income") @db.Decimal(18, 2)
  actualCumExpense  Decimal @default(0) @map("actual_cum_expense") @db.Decimal(18, 2)
  currency        String   @default("USD") @db.VarChar(3)
  notes           String?
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, periodType, periodNumber])
  @@index([projectId])
  @@index([periodStart])
  @@map("cash_flow_periods")
}
