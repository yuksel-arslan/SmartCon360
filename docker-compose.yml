version: "3.9"

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: smartcon360
      POSTGRES_PASSWORD: smartcon360_dev
      POSTGRES_DB: smartcon360
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  # ── API Gateway ──

  api-gateway:
    build: ./services/api-gateway
    ports: ["3000:3000"]
    env_file: .env
    environment:
      CORE_SERVICE_URL: http://core-service:3001
      OPS_SERVICE_URL: http://ops-service:3002
      PLATFORM_SERVICE_URL: http://platform-service:3003
      TAKT_SERVICE_URL: http://takt-service:8001
      AI_SERVICE_URL: http://ai-service:8002
      RISK_ENGINE_SERVICE_URL: http://ai-risk-engine:8010
    depends_on:
      - core-service
      - ops-service
      - platform-service
      - takt-service
      - ai-service
      - ai-risk-engine

  # ── Core Service (auth + project + constraint + progress + cost) ──

  core-service:
    build: ./services/core-service
    ports: ["3001:3001"]
    env_file: .env
    environment:
      PORT: 3001
      DATABASE_URL: ${DATABASE_URL:-postgresql://smartcon360:smartcon360_dev@postgres:5432/smartcon360}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-me}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    depends_on: [postgres, redis]

  # ── Ops Service (quality + safety + cost-routes + claims + risk + supply-chain + stakeholder + sustainability + comm) ──

  ops-service:
    build: ./services/ops-service
    ports: ["3002:3002"]
    env_file: .env
    environment:
      PORT: 3002
      DATABASE_URL: ${DATABASE_URL:-postgresql://smartcon360:smartcon360_dev@postgres:5432/smartcon360}
      CORE_SERVICE_URL: http://core-service:3001
    depends_on: [postgres]

  # ── Platform Service (hub + notification + resource + reporting stubs) ──

  platform-service:
    build: ./services/platform-service
    ports: ["3003:3003"]
    env_file: .env
    environment:
      PORT: 3003
      DATABASE_URL: ${DATABASE_URL:-postgresql://smartcon360:smartcon360_dev@postgres:5432/smartcon360}
      CORE_SERVICE_URL: http://core-service:3001
      OPS_SERVICE_URL: http://ops-service:3002
    depends_on: [postgres]

  # ── Takt Service (takt-engine + flowline + simulation) — Python ──

  takt-service:
    build: ./services/takt-service
    ports: ["8001:8001"]
    env_file: .env
    environment:
      PORT: 8001
      DATABASE_URL: ${DATABASE_URL:-postgresql://smartcon360:smartcon360_dev@postgres:5432/smartcon360}
      CORE_SERVICE_URL: http://core-service:3001
      MONTE_CARLO_ITERATIONS: 10000

  # ── AI Service (ai-planner + reporting + vision + analytics + bim + drl) — Python ──

  ai-service:
    build: ./services/ai-service
    ports: ["8002:8002"]
    env_file: .env
    environment:
      PORT: 8002
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      AI_MODEL: gemini-2.0-flash
      CORE_SERVICE_URL: http://core-service:3001

  # ── BIM Engine (Standalone IFC/BIM parsing) — Python ──

  bim-engine:
    build: ./smartcon_bim_engine
    ports: ["8005:8005"]
    env_file: .env
    environment:
      PORT: 8005

  # ── AI Risk Engine (Extension — Intelligence Layer) — Python ──

  ai-risk-engine:
    build: ./services/extensions/ai-risk-engine
    ports: ["8010:8010"]
    env_file: .env
    environment:
      PORT: 8010
      CORE_SERVICE_URL: http://core-service:3001
      OPS_SERVICE_URL: http://ops-service:3002
      DATABASE_URL: ${DATABASE_URL:-postgresql://smartcon360:smartcon360_dev@postgres:5432/smartcon360}
    depends_on: [core-service]

volumes:
  pgdata:
