version: "3.9"

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: taktflow
      POSTGRES_PASSWORD: taktflow_dev
      POSTGRES_DB: taktflow
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  # ── Platform Services ──

  api-gateway:
    build: ./services/api-gateway
    ports: ["3000:3000"]
    env_file: .env
    depends_on:
      - auth-service
      - project-service
      - takt-engine
      - flowline-service
      - constraint-service
      - ai-planner
      - ai-concierge
      - simulation-service
      - reporting-service
      - progress-service
      - quality-service
      - safety-service
      - cost-service
      - claims-service
      - supply-chain-service
      - risk-service
      - comm-service
      - stakeholder-service
      - sustainability-service
      - hub-service

  auth-service:
    build: ./services/auth-service
    ports: ["3001:3001"]
    env_file: .env
    depends_on: [postgres, redis]

  # ── TaktFlow (Planning & Scheduling) ──

  project-service:
    build: ./services/project-service
    ports: ["3002:3002"]
    env_file: .env
    depends_on: [postgres]

  takt-engine:
    build: ./services/takt-engine
    ports: ["8001:8001"]
    env_file: .env

  flowline-service:
    build: ./services/flowline-service
    ports: ["3003:3003"]
    env_file: .env

  ai-planner:
    build: ./services/ai-planner
    ports: ["8002:8002"]
    env_file: .env
    environment:
      PORT: 8002
      AI_MODEL: gemini-2.0-flash

  simulation-service:
    build: ./services/simulation-service
    ports: ["8003:8003"]
    env_file: .env
    environment:
      PORT: 8003
      MONTE_CARLO_ITERATIONS: 10000

  reporting-service:
    build: ./services/reporting-service
    ports: ["8004:8004"]
    env_file: .env
    environment:
      PORT: 8004

  progress-service:
    build: ./services/progress-service
    ports: ["3005:3005"]
    env_file: .env
    depends_on: [postgres, redis]

  constraint-service:
    build: ./services/constraint-service
    ports: ["3004:3004"]
    env_file: .env

  ai-concierge:
    build: ./services/ai-concierge
    ports: ["3008:3008"]
    env_file: .env
    environment:
      PORT: 3008
      TAKT_ENGINE_URL: http://takt-engine:8001
      CONSTRAINT_URL: http://constraint-service:3004
      PROGRESS_URL: http://progress-service:3005
      SIMULATION_URL: http://simulation-service:8003
      REPORTING_URL: http://reporting-service:8004

  # ── QualityGate ──

  quality-service:
    build: ./services/quality-service
    ports: ["3009:3009"]
    env_file: .env
    environment:
      PORT: 3009
    depends_on: [postgres]

  # ── SafeZone ──

  safety-service:
    build: ./services/safety-service
    ports: ["3010:3010"]
    env_file: .env
    environment:
      PORT: 3010
    depends_on: [postgres]

  # ── CostPilot ──

  cost-service:
    build: ./services/cost-service
    ports: ["3011:3011"]
    env_file: .env
    environment:
      PORT: 3011
    depends_on: [postgres]

  # ── ClaimShield ──

  claims-service:
    build: ./services/claims-service
    ports: ["3012:3012"]
    env_file: .env
    environment:
      PORT: 3012
    depends_on: [postgres]

  # ── SupplyChain AI ──

  supply-chain-service:
    build: ./services/supply-chain-service
    ports: ["3013:3013"]
    env_file: .env
    environment:
      PORT: 3013
    depends_on: [postgres]

  # ── RiskRadar ──

  risk-service:
    build: ./services/risk-service
    ports: ["3014:3014"]
    env_file: .env
    environment:
      PORT: 3014
    depends_on: [postgres]

  # ── CommHub ──

  comm-service:
    build: ./services/comm-service
    ports: ["3015:3015"]
    env_file: .env
    environment:
      PORT: 3015
    depends_on: [postgres]

  # ── StakeHub ──

  stakeholder-service:
    build: ./services/stakeholder-service
    ports: ["3016:3016"]
    env_file: .env
    environment:
      PORT: 3016
    depends_on: [postgres]

  # ── GreenSite ──

  sustainability-service:
    build: ./services/sustainability-service
    ports: ["3017:3017"]
    env_file: .env
    environment:
      PORT: 3017
    depends_on: [postgres]

  # ── VisionAI (Python) ──

  vision-service:
    build: ./services/vision-service
    ports: ["8008:8008"]
    env_file: .env
    environment:
      PORT: 8008

  # ── SmartCon360 Hub ──

  hub-service:
    build: ./services/hub-service
    ports: ["3018:3018"]
    env_file: .env
    environment:
      PORT: 3018
    depends_on: [postgres, redis]

volumes:
  pgdata:
