generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// EXISTING MODELS
// ============================================================================

model Project {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String    @db.VarChar(255)
  code            String    @unique @db.VarChar(50)
  description     String?
  projectType     String    @map("project_type") @db.VarChar(50)
  status          String    @default("planning") @db.VarChar(30)
  address         String?
  city            String?   @db.VarChar(100)
  country         String?   @db.VarChar(100)
  plannedStart    DateTime? @map("planned_start") @db.Date
  plannedFinish   DateTime? @map("planned_finish") @db.Date
  actualStart     DateTime? @map("actual_start") @db.Date
  actualFinish    DateTime? @map("actual_finish") @db.Date
  defaultTaktTime Int       @default(5) @map("default_takt_time")
  workingDays     Json      @default("[\"mon\",\"tue\",\"wed\",\"thu\",\"fri\"]") @map("working_days")
  budget          Decimal?  @db.Decimal(15, 2)
  currency        String    @default("USD") @db.VarChar(3)
  ownerId         String    @map("owner_id") @db.Uuid
  settings        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  locations    Location[]
  trades       Trade[]
  members      ProjectMember[]
  drawings     Drawing[]
  wbsNodes     WbsNode[]
  cbsNodes     CbsNode[]
  projectSetup ProjectSetup?

  @@index([ownerId])
  @@index([status])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @db.VarChar(50)
  trade     String?  @db.VarChar(100)
  status    String   @default("active") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@map("project_members")
}

model Location {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId    String   @map("project_id") @db.Uuid
  parentId     String?  @map("parent_id") @db.Uuid
  code         String   @db.VarChar(50)
  name         String   @db.VarChar(255)
  locationType String   @map("location_type") @db.VarChar(30)
  areaSqm      Decimal? @map("area_sqm") @db.Decimal(10, 2)
  volumeCbm    Decimal? @map("volume_cbm") @db.Decimal(10, 2)
  sortOrder    Int      @default(0) @map("sort_order")
  path         String?  @db.VarChar(500)
  depth        Int      @default(0)
  bimGuid      String?  @map("bim_guid") @db.VarChar(100)
  metadata     Json     @default("{}")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  project  Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent   Location?  @relation("LocationTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Location[] @relation("LocationTree")

  @@unique([projectId, code])
  @@index([projectId])
  @@index([parentId])
  @@index([path])
  @@map("locations")
}

model Trade {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId           String   @map("project_id") @db.Uuid
  name                String   @db.VarChar(100)
  code                String   @db.VarChar(20)
  color               String   @db.VarChar(7)
  defaultCrewSize     Int      @default(4) @map("default_crew_size")
  productivityRate    Decimal? @map("productivity_rate") @db.Decimal(8, 4)
  unitOfMeasure       String?  @map("unit_of_measure") @db.VarChar(20)
  sortOrder           Int      @default(0) @map("sort_order")
  predecessorTradeIds String[] @default([]) @map("predecessor_trade_ids") @db.Uuid
  companyName         String?  @map("company_name") @db.VarChar(255)
  contactName         String?  @map("contact_name") @db.VarChar(100)
  contactEmail        String?  @map("contact_email") @db.VarChar(255)
  discipline          String?  @db.VarChar(30)
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, code])
  @@index([projectId])
  @@map("trades")
}

// ============================================================================
// PROJECT SETUP â€” Drawing, WBS, CBS, BOQ Management
// ============================================================================

model Drawing {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId    String   @map("project_id") @db.Uuid

  fileName     String   @map("file_name") @db.VarChar(500)
  originalName String   @map("original_name") @db.VarChar(500)
  fileType     String   @map("file_type") @db.VarChar(10)
  fileSize     Int      @map("file_size")
  filePath     String   @map("file_path") @db.VarChar(1000)

  discipline   String   @db.VarChar(30)
  drawingNo    String?  @map("drawing_no") @db.VarChar(50)
  title        String?  @db.VarChar(255)
  revision     String?  @db.VarChar(10)
  sheetSize    String?  @map("sheet_size") @db.VarChar(10)

  status       String   @default("uploaded") @db.VarChar(20)
  uploadedBy   String?  @map("uploaded_by") @db.Uuid
  metadata     Json     @default("{}")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([discipline])
  @@map("drawings")
}

model WbsNode {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  parentId    String?  @map("parent_id") @db.Uuid

  code        String   @db.VarChar(50)
  name        String   @db.VarChar(255)
  description String?

  standard    String   @db.VarChar(30)
  level       Int      @default(1)
  sortOrder   Int      @default(0) @map("sort_order")
  path        String?  @db.VarChar(500)

  locationId  String?  @map("location_id") @db.Uuid
  tradeId     String?  @map("trade_id") @db.Uuid

  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  project  Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent   WbsNode?   @relation("WbsTree", fields: [parentId], references: [id], onDelete: Cascade)
  children WbsNode[]  @relation("WbsTree")
  cbsNodes CbsNode[]

  @@unique([projectId, code])
  @@index([projectId])
  @@index([parentId])
  @@index([path])
  @@map("wbs_nodes")
}

model CbsNode {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  parentId    String?  @map("parent_id") @db.Uuid
  wbsNodeId   String?  @map("wbs_node_id") @db.Uuid

  code        String   @db.VarChar(50)
  name        String   @db.VarChar(255)
  description String?

  standard    String   @db.VarChar(30)
  level       Int      @default(1)
  sortOrder   Int      @default(0) @map("sort_order")
  path        String?  @db.VarChar(500)

  budgetCode  String?  @map("budget_code") @db.VarChar(30)

  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  project  Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent   CbsNode?   @relation("CbsTree", fields: [parentId], references: [id], onDelete: Cascade)
  children CbsNode[]  @relation("CbsTree")
  wbsNode  WbsNode?   @relation(fields: [wbsNodeId], references: [id])

  @@unique([projectId, code])
  @@index([projectId])
  @@index([parentId])
  @@index([wbsNodeId])
  @@map("cbs_nodes")
}

model ProjectSetup {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String @unique @map("project_id") @db.Uuid

  currentStep    String   @default("classification") @map("current_step") @db.VarChar(30)
  completedSteps String[] @default([]) @map("completed_steps")

  classificationStandard String @default("uniclass") @map("classification_standard") @db.VarChar(30)

  boqUploaded  Boolean @default(false) @map("boq_uploaded")
  boqFileName  String? @map("boq_file_name") @db.VarChar(500)
  boqItemCount Int     @default(0) @map("boq_item_count")

  drawingCount Int @default(0) @map("drawing_count")

  wbsGenerated      Boolean @default(false) @map("wbs_generated")
  wbsNodeCount      Int     @default(0) @map("wbs_node_count")
  cbsGenerated      Boolean @default(false) @map("cbs_generated")
  cbsNodeCount      Int     @default(0) @map("cbs_node_count")

  taktPlanGenerated Boolean @default(false) @map("takt_plan_generated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_setup")
}
